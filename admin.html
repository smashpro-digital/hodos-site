<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HODOS Admin — Quests & Assets</title>
  <style>
    :root{
      --bg:#F6EFE4; --bg2:#FBF7EF; --card:#fff; --ink:#1A1A1A;
      --gold:#C58A2C; --gold2:#F7D27A; --gold-dark:#6B3F1D; --line: rgba(197,138,44,.18);
      --shadow: 0 16px 40px rgba(0,0,0,.12); --r: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --serif: ui-serif, Georgia, "Times New Roman", Times, serif;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);
      background: radial-gradient(1200px 700px at 15% 0%, rgba(197,138,44,.16), transparent 55%),
                  radial-gradient(900px 600px at 85% 10%, rgba(247,210,122,.18), transparent 60%),
                  linear-gradient(180deg,var(--bg2),var(--bg));
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:34px 16px 60px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-family:var(--serif);color:var(--gold-dark);letter-spacing:.2px}
    .card{background:rgba(255,255,255,.85);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid rgba(197,138,44,.32);background:rgba(255,255,255,.75);border-radius:999px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn.primary{background:radial-gradient(circle at top,var(--gold2),var(--gold));color:#3A240F}
    .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:7px 10px;border:1px solid rgba(197,138,44,.22);background:rgba(232,214,184,.65);font-weight:800}
    .grid{display:grid;grid-template-columns: 1.2fr .8fr; gap:14px; margin-top:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(0,0,0,.06);vertical-align:top}
    th{font-size:12px;text-transform:uppercase;letter-spacing:.6px;color:rgba(58,36,15,.75);text-align:left}
    td code{font-family:var(--mono);font-size:12px}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(197,138,44,.28);background:#fff}
    textarea{min-height:110px}
    .muted{opacity:.78}
    .two{display:grid;grid-template-columns:1fr 1fr; gap:10px}
    @media(max-width:720px){.two{grid-template-columns:1fr}}
    .hr{height:1px;background:linear-gradient(90deg,transparent,var(--line),transparent);margin:12px 0}
    .mini{font-size:12px;color:rgba(58,36,15,.78)}
    .ok{color:#1b5e20;font-weight:800}
    .err{color:#8b0000;font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>HODOS Admin</h1>
        <div class="mini">Quests, releases, and asset jobs queue (GitHub-authenticated)</div>
      </div>
      <div class="row">
        <span class="pill" id="who">Checking session…</span>
        <button class="btn" id="loginBtn">Login with GitHub</button>
        <button class="btn" id="logoutBtn">Logout</button>
        <button class="btn primary" id="reloadBtn">Reload</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div class="pill">Quests</div>
          <div class="row">
            <select id="appSlug" style="max-width:220px;">
              <option value="hodos">hodos</option>
            </select>
            <button class="btn" id="loadQuestsBtn">Load quests</button>
          </div>
        </div>

        <div class="hr"></div>

        <div id="questState" class="muted">No data loaded yet.</div>
        <div style="overflow:auto;">
          <table id="questTable" style="display:none;">
            <thead>
              <tr>
                <th>Code</th>
                <th>Title</th>
                <th>Published</th>
                <th>Release</th>
                <th>Hero Image</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="questTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="pill">Asset Jobs</div>
        <div class="hr"></div>

        <div class="row" style="justify-content:space-between;">
          <select id="jobStatus" style="max-width:220px;">
            <option value="active">active</option>
            <option value="queued">queued</option>
            <option value="in_progress">in_progress</option>
            <option value="done">done</option>
            <option value="failed">failed</option>
            <option value="all">all</option>
          </select>
          <button class="btn" id="loadJobsBtn">Load jobs</button>
        </div>

        <div class="hr"></div>

        <div id="jobState" class="muted">No jobs loaded yet.</div>
        <div style="overflow:auto; max-height:520px;">
          <table id="jobTable" style="display:none;">
            <thead>
              <tr>
                <th>ID</th>
                <th>Quest</th>
                <th>Type</th>
                <th>Status</th>
                <th>Prompt</th>
              </tr>
            </thead>
            <tbody id="jobTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------- CONFIG ----------
  const API_BASE = "https://smashpro.app/api/v1/admin";
  const UI_REDIRECT = location.href; // after callback, you land here

  // Endpoints
  const EP = {
    startAuth: `${API_BASE}/github/start.php`,
    sessionGet: `${API_BASE}/session/get.php`,
    logout: `${API_BASE}/session/logout.php`,
    questsList: `${API_BASE}/quests/list.php`,
    questsUpdate: `${API_BASE}/quests/update.php`,
    jobsList: `${API_BASE}/jobs/list.php`,
    jobsCreate: `${API_BASE}/jobs/create.php`,
    promptsQuestTile: `${API_BASE}/prompts/quest_tile.php`,
  };

  // ---------- UI ----------
  const who = document.getElementById("who");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const reloadBtn = document.getElementById("reloadBtn");

  const appSlug = document.getElementById("appSlug");
  const loadQuestsBtn = document.getElementById("loadQuestsBtn");
  const questState = document.getElementById("questState");
  const questTable = document.getElementById("questTable");
  const questTbody = document.getElementById("questTbody");

  const jobStatus = document.getElementById("jobStatus");
  const loadJobsBtn = document.getElementById("loadJobsBtn");
  const jobState = document.getElementById("jobState");
  const jobTable = document.getElementById("jobTable");
  const jobTbody = document.getElementById("jobTbody");

  let SESSION = null;

  function esc(s){ return String(s ?? "").replace(/[&<>"]/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }

  async function jget(url){
    const r = await fetch(url, { credentials: "include" });
    const ct = (r.headers.get("content-type")||"").toLowerCase();
    const data = ct.includes("application/json") ? await r.json() : { _text: await r.text() };
    if (!r.ok || data.ok === false) throw new Error(data.error || data.message || `HTTP ${r.status}`);
    return data;
  }

  async function jpost(url, body){
    const r = await fetch(url, {
      method:"POST",
      credentials:"include",
      headers:{ "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify(body || {})
    });
    const ct = (r.headers.get("content-type")||"").toLowerCase();
    const data = ct.includes("application/json") ? await r.json() : { _text: await r.text() };
    if (!r.ok || data.ok === false) throw new Error(data.error || data.message || `HTTP ${r.status}`);
    return data;
  }

  async function refreshSession(){
    const s = await jget(EP.sessionGet);
    SESSION = s.authenticated ? s.admin : null;
    if (SESSION) {
      who.innerHTML = `✅ <strong>${esc(SESSION.login)}</strong>`;
      who.className = "pill ok";
    } else {
      who.textContent = "Not logged in";
      who.className = "pill muted";
    }
  }

  async function login(){
    const r = await jget(EP.startAuth);
    if (!r.auth_url) throw new Error("Missing auth_url");
    // Redirect to GitHub OAuth
    location.href = r.auth_url;
  }

  async function logout(){
    await jget(EP.logout);
    await refreshSession();
  }

  function questRow(q){
    const published = (q.is_published == 1 || q.is_published === true) ? "1" : "0";
    const rel = q.target_release_date || "";
    const hero = q.hero_image || "";
    return `
      <tr data-id="${esc(q.id)}" data-code="${esc(q.code)}">
        <td><code>${esc(q.code)}</code></td>
        <td><input data-k="title" value="${esc(q.title||"")}" /></td>
        <td>
          <select data-k="is_published">
            <option value="0" ${published==="0"?"selected":""}>0</option>
            <option value="1" ${published==="1"?"selected":""}>1</option>
          </select>
        </td>
        <td><input data-k="target_release_date" placeholder="YYYY-MM-DD" value="${esc(rel)}" /></td>
        <td><input data-k="hero_image" placeholder="assets/quests/<code>.jpg" value="${esc(hero)}" /></td>
        <td>
          <div class="row">
            <button class="btn" data-action="save">Save</button>
            <button class="btn" data-action="prompt">Gen Prompt</button>
            <button class="btn primary" data-action="queue">Queue Tile Job</button>
          </div>
        </td>
      </tr>
    `;
  }

  async function loadQuests(){
    questState.textContent = "Loading quests…";
    questTable.style.display = "none";
    questTbody.innerHTML = "";

    const data = await jget(`${EP.questsList}?app_slug=${encodeURIComponent(appSlug.value)}`);
    const quests = Array.isArray(data.quests) ? data.quests : [];

    if (!quests.length){
      questState.textContent = "No quests returned.";
      return;
    }
    questState.textContent = "";
    questTable.style.display = "";
    questTbody.innerHTML = quests.map(questRow).join("");
  }

  async function loadJobs(){
    jobState.textContent = "Loading jobs…";
    jobTable.style.display = "none";
    jobTbody.innerHTML = "";

    const url = `${EP.jobsList}?app_slug=${encodeURIComponent(appSlug.value)}&status=${encodeURIComponent(jobStatus.value)}`;
    const data = await jget(url);
    const jobs = Array.isArray(data.jobs) ? data.jobs : [];

    if (!jobs.length){
      jobState.textContent = "No jobs found for this filter.";
      return;
    }
    jobState.textContent = "";
    jobTable.style.display = "";
    jobTbody.innerHTML = jobs.map(j => `
      <tr>
        <td><code>${esc(j.id)}</code></td>
        <td><code>${esc(j.quest_code)}</code></td>
        <td>${esc(j.job_type)}</td>
        <td>${esc(j.status)}</td>
        <td class="muted">${esc((j.prompt||"").slice(0,120))}${(j.prompt||"").length>120?"…":""}</td>
      </tr>
    `).join("");
  }

  // Table event delegation
  questTbody.addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-action]");
    if (!btn) return;

    const tr = btn.closest("tr");
    const id = Number(tr?.dataset?.id || 0);
    const code = tr?.dataset?.code || "";
    const action = btn.dataset.action;

    if (!id || !code) return;

    const fields = {};
    tr.querySelectorAll("[data-k]").forEach(el => fields[el.dataset.k] = el.value);

    try {
      btn.disabled = true;
      if (action === "save") {
        await jpost(EP.questsUpdate, { id, ...fields });
        btn.textContent = "Saved ✅";
        setTimeout(()=>btn.textContent="Save", 900);
      }

      if (action === "prompt") {
        const promptRes = await jpost(EP.promptsQuestTile, {
          quest_code: code,
          title: fields.title || ""
        });
        window.prompt("Quest Tile Prompt (copy):", promptRes.prompt);
      }

      if (action === "queue") {
        const promptRes = await jpost(EP.promptsQuestTile, {
          quest_code: code,
          title: fields.title || ""
        });

        await jpost(EP.jobsCreate, {
          app_slug: appSlug.value,
          quest_code: code,
          job_type: "quest_tile",
          priority: 50,
          prompt: promptRes.prompt,
          negative_prompt: promptRes.negative_prompt
        });

        btn.textContent = "Queued ✅";
        setTimeout(()=>btn.textContent="Queue Tile Job", 900);
        await loadJobs();
      }
    } catch (err) {
      console.error(err);
      alert(err?.message || "Action failed");
    } finally {
      btn.disabled = false;
    }
  });

  loginBtn.addEventListener("click", () => login().catch(err => alert(err.message)));
  logoutBtn.addEventListener("click", () => logout().catch(err => alert(err.message)));
  reloadBtn.addEventListener("click", async () => {
    await refreshSession();
    if (SESSION) {
      await loadQuests();
      await loadJobs();
    }
  });

  loadQuestsBtn.addEventListener("click", () => loadQuests().catch(err => alert(err.message)));
  loadJobsBtn.addEventListener("click", () => loadJobs().catch(err => alert(err.message)));

  // Boot
  (async () => {
    await refreshSession();
    if (SESSION) {
      await loadQuests();
      await loadJobs();
    }
  })();
</script>
</body>
</html>
