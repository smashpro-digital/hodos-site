<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HODOS Admin ‚Äî Quests & Assets</title>
  <meta name="description" content="HODOS Admin tool for quests and asset job queue." />

  <style>
    :root{
      --bg:#F6EFE4; --bg2:#FBF7EF; --card:#fff; --ink:#1A1A1A;
      --gold:#C58A2C; --gold2:#F7D27A; --gold-dark:#6B3F1D; --line: rgba(197,138,44,.18);
      --shadow: 0 16px 40px rgba(0,0,0,.12); --r: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --serif: ui-serif, Georgia, "Times New Roman", Times, serif;
      --ok:#1b5e20; --err:#8b0000;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);
      background: radial-gradient(1200px 700px at 15% 0%, rgba(197,138,44,.16), transparent 55%),
                  radial-gradient(900px 600px at 85% 10%, rgba(247,210,122,.18), transparent 60%),
                  linear-gradient(180deg,var(--bg2),var(--bg));
      min-height:100vh;
    }
    .wrap{max-width:1250px;margin:0 auto;padding:34px 16px 60px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-family:var(--serif);color:var(--gold-dark);letter-spacing:.2px}
    .sub{font-size:12px;color:rgba(58,36,15,.78);margin-top:4px}
    .card{background:rgba(255,255,255,.85);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid rgba(197,138,44,.32);background:rgba(255,255,255,.75);border-radius:999px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn.primary{background:radial-gradient(circle at top,var(--gold2),var(--gold));color:#3A240F}
    .btn.danger{border-color: rgba(190,0,0,.25); background: rgba(255,150,150,.15); color:#3A240F;}
    .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:7px 10px;border:1px solid rgba(197,138,44,.22);background:rgba(232,214,184,.65);font-weight:800}
    .grid{display:grid;grid-template-columns: 1.2fr .8fr; gap:14px; margin-top:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(0,0,0,.06);vertical-align:top}
    th{font-size:12px;text-transform:uppercase;letter-spacing:.6px;color:rgba(58,36,15,.75);text-align:left}
    td code{font-family:var(--mono);font-size:12px}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(197,138,44,.28);background:#fff}
    textarea{min-height:110px}
    .muted{opacity:.78}
    .two{display:grid;grid-template-columns:1fr 1fr; gap:10px}
    @media(max-width:720px){.two{grid-template-columns:1fr}}
    .hr{height:1px;background:linear-gradient(90deg,transparent,var(--line),transparent);margin:12px 0}
    .mini{font-size:12px;color:rgba(58,36,15,.78)}
    .ok{color:var(--ok);font-weight:900}
    .err{color:var(--err);font-weight:900}
    .banner{
      margin-top:14px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(197,138,44,.20);
      background: rgba(232,214,184,.45);
      color:#3A240F;
      display:none;
      white-space:pre-wrap;
    }
    .banner.show{display:block}
    .banner.err{background: rgba(255,150,150,.18); border-color: rgba(190,0,0,.20);}
    .banner.ok{background: rgba(180,255,180,.14); border-color: rgba(0,120,0,.18);}
    .chip{
      font-family: var(--mono);
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.7);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>HODOS Admin</h1>
        <div class="sub">Quests, releases, and asset jobs queue <span class="chip">AUTH BYPASS MODE</span></div>
      </div>
      <div class="row">
        <span class="pill" id="who">üîì Auth bypass enabled</span>
        <button class="btn primary" id="reloadBtn">Reload</button>
        <button class="btn danger" id="clearBtn">Clear UI</button>
      </div>
    </div>

    <div class="banner" id="banner"></div>

    <div class="grid">
      <!-- LEFT: QUESTS -->
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div class="pill">Quests</div>
          <div class="row">
            <select id="appSlug" style="max-width:220px;">
              <option value="hodos">hodos</option>
            </select>
            <button class="btn" id="loadQuestsBtn">Load quests</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="mini muted" style="margin-bottom:10px;">
          Tip: set <b>Hero Image</b> to a site path like <span class="chip">assets/quests/returning_light.jpg</span>.
          Your public pages can render real scenes per <code>quest_code</code>.
        </div>

        <div id="questState" class="muted">No data loaded yet.</div>

        <div style="overflow:auto;">
          <table id="questTable" style="display:none;">
            <thead>
              <tr>
                <th>Code</th>
                <th>Title</th>
                <th>Published</th>
                <th>Release</th>
                <th>Hero Image</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="questTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT: JOBS -->
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div class="pill">Asset Jobs</div>
          <div class="row" style="justify-content:flex-end;">
            <label class="mini muted" style="display:flex;gap:8px;align-items:center;">
              <input id="useCookies" type="checkbox" style="width:auto;" />
              Use cookies (later OAuth)
            </label>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row" style="justify-content:space-between;">
          <select id="jobStatus" style="max-width:220px;">
            <option value="active">active</option>
            <option value="queued">queued</option>
            <option value="in_progress">in_progress</option>
            <option value="done">done</option>
            <option value="failed">failed</option>
            <option value="all">all</option>
          </select>
          <button class="btn" id="loadJobsBtn">Load jobs</button>
        </div>

        <div class="hr"></div>

        <div id="jobState" class="muted">No jobs loaded yet.</div>

        <div style="overflow:auto; max-height:520px;">
          <table id="jobTable" style="display:none;">
            <thead>
              <tr>
                <th>ID</th>
                <th>Quest</th>
                <th>Type</th>
                <th>Status</th>
                <th>Prompt</th>
              </tr>
            </thead>
            <tbody id="jobTbody"></tbody>
          </table>
        </div>

        <div class="hr"></div>
        <div class="mini muted">
          If you see <b>CORS error</b> in DevTools but the network row says <b>200 OK</b>, your endpoint is returning
          without <span class="chip">Access-Control-Allow-Origin</span> (or you used cookies without
          <span class="chip">Access-Control-Allow-Credentials: true</span>).
        </div>
      </div>
    </div>
  </div>

<script>
  /* -----------------------------
     CONFIG (AUTH BYPASS MODE)
  ------------------------------ */

  // IMPORTANT: keep consistent with your live server folders.
  const API_BASE_ADMIN = "https://smashpro.app/api/v1/admin";
  const API_BASE_PUBLIC = "https://smashpro.app/api/public";

  const EP = {
    // Admin (bypass mode)
    questsList:   `${API_BASE_ADMIN}/quests/list.php`,
    questsUpdate: `${API_BASE_ADMIN}/quests/update.php`,
    jobsList:     `${API_BASE_ADMIN}/jobs/list.php`,
    jobsCreate:   `${API_BASE_ADMIN}/jobs/create.php`,
    promptsQuestTile: `${API_BASE_ADMIN}/prompts/quest_tile.php`,

    // Public check (handy for sanity)
    publicQuestIndex: `${API_BASE_PUBLIC}/quest/index.php`,
  };

  /* -----------------------------
     UI refs
  ------------------------------ */
  const banner = document.getElementById("banner");
  const reloadBtn = document.getElementById("reloadBtn");
  const clearBtn = document.getElementById("clearBtn");

  const appSlug = document.getElementById("appSlug");
  const loadQuestsBtn = document.getElementById("loadQuestsBtn");
  const questState = document.getElementById("questState");
  const questTable = document.getElementById("questTable");
  const questTbody = document.getElementById("questTbody");

  const useCookies = document.getElementById("useCookies");
  const jobStatus = document.getElementById("jobStatus");
  const loadJobsBtn = document.getElementById("loadJobsBtn");
  const jobState = document.getElementById("jobState");
  const jobTable = document.getElementById("jobTable");
  const jobTbody = document.getElementById("jobTbody");

  function esc(s){
    return String(s ?? "").replace(/[&<>"]/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
  }

  function cid(){
    // cheap correlation id for browser-side tracing
    return (crypto?.randomUUID?.() || (Date.now()+"-"+Math.random().toString(16).slice(2)));
  }

  function showBanner(type, msg){
    banner.className = "banner show " + (type === "ok" ? "ok" : "err");
    banner.textContent = msg || "";
  }
  function clearBanner(){
    banner.className = "banner";
    banner.textContent = "";
  }

  async function safeJson(res){
    const ct = (res.headers.get("content-type")||"").toLowerCase();
    if (ct.includes("application/json")) return await res.json().catch(()=> ({}));
    const text = await res.text().catch(()=> "");
    return { _text: text };
  }

  async function apiGet(url){
    const corr = cid();
    const opts = {
      method: "GET",
      mode: "cors",
      credentials: useCookies.checked ? "include" : "omit",
      headers: {
        "Accept": "application/json",
        "X-Correlation-Id": corr,
      }
    };

    try{
      const res = await fetch(url, opts);
      const data = await safeJson(res);

      if (!res.ok || data.ok === false){
        const msg = data.error || data.message || data._text || `HTTP ${res.status}`;
        throw new Error(`${msg}\n(correlation: ${data.correlation_id || corr})`);
      }
      return data;
    }catch(err){
      // When CORS blocks, fetch throws TypeError: Failed to fetch with no body access.
      const emsg = (err && err.message) ? err.message : String(err);
      throw new Error(`${emsg}\n\nIf this is a CORS block, fix server headers for origin:\n${location.origin}\n`);
    }
  }

  async function apiPost(url, body){
    const corr = cid();
    const opts = {
      method: "POST",
      mode: "cors",
      credentials: useCookies.checked ? "include" : "omit",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json",
        "X-Correlation-Id": corr,
      },
      body: JSON.stringify(body || {})
    };

    try{
      const res = await fetch(url, opts);
      const data = await safeJson(res);

      if (!res.ok || data.ok === false){
        const msg = data.error || data.message || data._text || `HTTP ${res.status}`;
        throw new Error(`${msg}\n(correlation: ${data.correlation_id || corr})`);
      }
      return data;
    }catch(err){
      const emsg = (err && err.message) ? err.message : String(err);
      throw new Error(`${emsg}\n\nIf this is a CORS block, fix server headers for origin:\n${location.origin}\n`);
    }
  }

  /* -----------------------------
     Renderers
  ------------------------------ */
  function questRow(q){
    const published = (q.is_published == 1 || q.is_published === true) ? "1" : "0";
    const rel = q.target_release_date || "";
    const hero = q.hero_image || "";
    return `
      <tr data-id="${esc(q.id)}" data-code="${esc(q.code)}">
        <td><code>${esc(q.code)}</code></td>
        <td><input data-k="title" value="${esc(q.title||"")}" /></td>
        <td>
          <select data-k="is_published">
            <option value="0" ${published==="0"?"selected":""}>0</option>
            <option value="1" ${published==="1"?"selected":""}>1</option>
          </select>
        </td>
        <td><input data-k="target_release_date" placeholder="YYYY-MM-DD" value="${esc(rel)}" /></td>
        <td><input data-k="hero_image" placeholder="assets/quests/<code>.jpg" value="${esc(hero)}" /></td>
        <td>
          <div class="row">
            <button class="btn" data-action="save">Save</button>
            <button class="btn" data-action="prompt">Gen Prompt</button>
            <button class="btn primary" data-action="queue">Queue Tile Job</button>
          </div>
        </td>
      </tr>
    `;
  }

  /* -----------------------------
     Loaders
  ------------------------------ */
  async function loadQuests(){
    clearBanner();
    questState.textContent = "Loading quests‚Ä¶";
    questTable.style.display = "none";
    questTbody.innerHTML = "";

    const url = `${EP.questsList}?app_slug=${encodeURIComponent(appSlug.value)}`;
    const data = await apiGet(url);
    const quests = Array.isArray(data.quests) ? data.quests : [];

    if (!quests.length){
      questState.textContent = "No quests returned.";
      return;
    }

    questState.textContent = "";
    questTable.style.display = "";
    questTbody.innerHTML = quests.map(questRow).join("");
  }

  async function loadJobs(){
    clearBanner();
    jobState.textContent = "Loading jobs‚Ä¶";
    jobTable.style.display = "none";
    jobTbody.innerHTML = "";

    const url = `${EP.jobsList}?app_slug=${encodeURIComponent(appSlug.value)}&status=${encodeURIComponent(jobStatus.value)}`;
    const data = await apiGet(url);
    const jobs = Array.isArray(data.jobs) ? data.jobs : [];

    if (!jobs.length){
      jobState.textContent = "No jobs found for this filter.";
      return;
    }

    jobState.textContent = "";
    jobTable.style.display = "";
    jobTbody.innerHTML = jobs.map(j => `
      <tr>
        <td><code>${esc(j.id)}</code></td>
        <td><code>${esc(j.quest_code)}</code></td>
        <td>${esc(j.job_type)}</td>
        <td>${esc(j.status)}</td>
        <td class="muted">${esc((j.prompt||"").slice(0,140))}${(j.prompt||"").length>140?"‚Ä¶":""}</td>
      </tr>
    `).join("");
  }

  /* -----------------------------
     Actions
  ------------------------------ */
  questTbody.addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-action]");
    if (!btn) return;

    const tr = btn.closest("tr");
    const id = Number(tr?.dataset?.id || 0);
    const code = tr?.dataset?.code || "";
    const action = btn.dataset.action;

    if (!id || !code) return;

    const fields = {};
    tr.querySelectorAll("[data-k]").forEach(el => fields[el.dataset.k] = el.value);

    try {
      clearBanner();
      btn.disabled = true;

      if (action === "save") {
        await apiPost(EP.questsUpdate, { id, ...fields });
        btn.textContent = "Saved ‚úÖ";
        setTimeout(()=>btn.textContent="Save", 900);
        showBanner("ok", `Saved quest: ${code}`);
      }

      if (action === "prompt") {
        const promptRes = await apiPost(EP.promptsQuestTile, {
          quest_code: code,
          title: fields.title || ""
        });
        window.prompt("Quest Tile Prompt (copy):", promptRes.prompt || "");
      }

      if (action === "queue") {
        const promptRes = await apiPost(EP.promptsQuestTile, {
          quest_code: code,
          title: fields.title || ""
        });

        await apiPost(EP.jobsCreate, {
          app_slug: appSlug.value,
          quest_code: code,
          job_type: "quest_tile",
          priority: 50,
          prompt: promptRes.prompt,
          negative_prompt: promptRes.negative_prompt
        });

        btn.textContent = "Queued ‚úÖ";
        setTimeout(()=>btn.textContent="Queue Tile Job", 900);
        showBanner("ok", `Queued job for quest: ${code}`);
        await loadJobs();
      }
    } catch (err) {
      console.error(err);
      showBanner("err", err?.message || "Action failed");
      alert(err?.message || "Action failed");
    } finally {
      btn.disabled = false;
    }
  });

  /* -----------------------------
     Buttons
  ------------------------------ */
  loadQuestsBtn.addEventListener("click", () => loadQuests().catch(err => showBanner("err", err.message)));
  loadJobsBtn.addEventListener("click", () => loadJobs().catch(err => showBanner("err", err.message)));

  reloadBtn.addEventListener("click", async () => {
    try{
      clearBanner();
      await loadQuests();
      await loadJobs();
    }catch(err){
      showBanner("err", err?.message || "Reload failed");
    }
  });

  clearBtn.addEventListener("click", () => {
    clearBanner();
    questState.textContent = "No data loaded yet.";
    questTable.style.display = "none";
    questTbody.innerHTML = "";
    jobState.textContent = "No jobs loaded yet.";
    jobTable.style.display = "none";
    jobTbody.innerHTML = "";
  });

  /* -----------------------------
     Boot
  ------------------------------ */
  (async () => {
    // Don‚Äôt auto-load on first paint to avoid confusing ‚ÄúFailed to fetch‚Äù before server is fixed.
    // Click Reload when ready.
  })();
</script>

</body>
</html>
