<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HODOS Admin ‚Äî Quests & Assets</title>
  <meta name="robots" content="noindex,nofollow" />

  <style>
    :root{
      --bg:#F6EFE4; --bg2:#FBF7EF; --card:#fff; --ink:#1A1A1A;
      --gold:#C58A2C; --gold2:#F7D27A; --gold-dark:#6B3F1D; --line: rgba(197,138,44,.18);
      --shadow: 0 16px 40px rgba(0,0,0,.12); --r: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --serif: ui-serif, Georgia, "Times New Roman", Times, serif;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);
      background:
        radial-gradient(1200px 700px at 15% 0%, rgba(197,138,44,.16), transparent 55%),
        radial-gradient(900px 600px at 85% 10%, rgba(247,210,122,.18), transparent 60%),
        linear-gradient(180deg,var(--bg2),var(--bg));
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:34px 16px 60px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-family:var(--serif);color:var(--gold-dark);letter-spacing:.2px}
    .sub{font-size:12px;color:rgba(58,36,15,.78);margin-top:4px}
    .card{background:rgba(255,255,255,.85);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid rgba(197,138,44,.32);background:rgba(255,255,255,.75);border-radius:999px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn.primary{background:radial-gradient(circle at top,var(--gold2),var(--gold));color:#3A240F}
    .btn.danger{border-color:rgba(190,0,0,.25);background:rgba(255,150,150,.12)}
    .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:7px 10px;border:1px solid rgba(197,138,44,.22);background:rgba(232,214,184,.65);font-weight:800}
    .pill.warn{background:rgba(255,214,102,.35);border-color:rgba(197,138,44,.25)}
    .pill.ok{background:rgba(46,125,50,.14);border-color:rgba(46,125,50,.25);color:#1b5e20}
    .pill.err{background:rgba(255,150,150,.20);border-color:rgba(190,0,0,.22);color:#8b0000}
    .grid{display:grid;grid-template-columns: 1.2fr .8fr; gap:14px; margin-top:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(0,0,0,.06);vertical-align:top}
    th{font-size:12px;text-transform:uppercase;letter-spacing:.6px;color:rgba(58,36,15,.75);text-align:left}
    td code{font-family:var(--mono);font-size:12px}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(197,138,44,.28);background:#fff}
    textarea{min-height:110px}
    .muted{opacity:.78}
    .two{display:grid;grid-template-columns:1fr 1fr; gap:10px}
    @media(max-width:720px){.two{grid-template-columns:1fr}}
    .hr{height:1px;background:linear-gradient(90deg,transparent,var(--line),transparent);margin:12px 0}
    .mini{font-size:12px;color:rgba(58,36,15,.78)}
    .tip{font-size:12px;color:rgba(58,36,15,.70);margin-top:10px;line-height:1.5}
    .notice{
      margin-top:12px;padding:12px 14px;border-radius:16px;border:1px solid rgba(197,138,44,.20);
      background:rgba(232,214,184,.45);color:#3A240F;display:none;white-space:pre-wrap
    }
    .notice.show{display:block}
    .notice.ok{background:rgba(46,125,50,.12);border-color:rgba(46,125,50,.20)}
    .notice.err{background:rgba(255,150,150,.18);border-color:rgba(190,0,0,.18)}
    .badge{
      display:inline-flex;align-items:center;gap:8px;font-size:12px;
      padding:6px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.06);
      background:rgba(255,255,255,.65)
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>HODOS Admin</h1>
        <div class="sub">Quests, releases, and asset jobs queue (AUTH BYPASS MODE)</div>
      </div>
      <div class="row">
        <span class="pill warn" id="modePill">üîì Auth bypass enabled</span>
        <button class="btn primary" id="reloadBtn">Reload</button>
        <button class="btn danger" id="hardResetBtn" title="Clears UI state only (not server)">Clear UI</button>
      </div>
    </div>

    <div class="notice" id="notice"></div>

    <div class="grid">
      <!-- LEFT: Quests -->
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div class="pill">Quests</div>
          <div class="row">
            <select id="appSlug" style="max-width:220px;">
              <option value="hodos">hodos</option>
            </select>
            <button class="btn" id="loadQuestsBtn">Load quests</button>
          </div>
        </div>

        <div class="hr"></div>

        <div id="questState" class="muted">No data loaded yet.</div>

        <div class="tip">
          Tip: ‚ÄúHero Image‚Äù should be a site path like
          <span class="badge"><code>assets/quests/returning_light.jpg</code></span>.
          Your quest tiles (public pages) can read this and render real scenes per <code>quest_code</code>.
        </div>

        <div style="overflow:auto;margin-top:10px;">
          <table id="questTable" style="display:none;">
            <thead>
              <tr>
                <th>Code</th>
                <th>Title</th>
                <th>Published</th>
                <th>Release</th>
                <th>Hero Image</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="questTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT: Jobs -->
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div class="pill">Asset Jobs</div>
          <div class="row">
            <select id="jobStatus" style="max-width:220px;">
              <option value="active">active</option>
              <option value="queued">queued</option>
              <option value="in_progress">in_progress</option>
              <option value="done">done</option>
              <option value="failed">failed</option>
              <option value="all">all</option>
            </select>
            <button class="btn" id="loadJobsBtn">Load jobs</button>
          </div>
        </div>

        <div class="hr"></div>

        <div id="jobState" class="muted">No jobs loaded yet.</div>

        <div style="overflow:auto; max-height:520px;margin-top:10px;">
          <table id="jobTable" style="display:none;">
            <thead>
              <tr>
                <th>ID</th>
                <th>Quest</th>
                <th>Type</th>
                <th>Status</th>
                <th>Prompt</th>
              </tr>
            </thead>
            <tbody id="jobTbody"></tbody>
          </table>
        </div>

        <div class="tip">
          If your API returns JSON like <code>{ ok:false, error:"Server config error", correlation_id:"..." }</code>,
          paste the <code>correlation_id</code> into your server logs lookup so you can find the exact fatal path/line.
        </div>
      </div>
    </div>
  </div>

<script>
  // =========================
  // CONFIG (AUTH BYPASS MODE)
  // =========================
  // Admin endpoints (write actions)
  const ADMIN_BASE = "https://smashpro.app/api/v1/admin";

  // Public quests endpoint (read-only fallback)
  const PUBLIC_QUESTS = "https://smashpro.app/api/public/quest/index.php";

  // Toggle which list endpoint to use first:
  // - true: try ADMIN list first, fall back to PUBLIC if it errors
  // - false: use PUBLIC list only
  const TRY_ADMIN_LIST_FIRST = true;

  // Endpoints
  const EP = {
    // read
    questsListAdmin: `${ADMIN_BASE}/quests/list.php`,
    questsListPublic: `${PUBLIC_QUESTS}`,

    jobsList: `${ADMIN_BASE}/jobs/list.php`,

    // write
    questsUpdate: `${ADMIN_BASE}/quests/update.php`,
    jobsCreate: `${ADMIN_BASE}/jobs/create.php`,

    // prompt endpoint (optional; UI has local fallback)
    promptsQuestTile: `${ADMIN_BASE}/prompts/quest_tile.php`,
  };

  // =========================
  // UI refs
  // =========================
  const notice = document.getElementById("notice");
  const reloadBtn = document.getElementById("reloadBtn");
  const hardResetBtn = document.getElementById("hardResetBtn");

  const appSlug = document.getElementById("appSlug");
  const loadQuestsBtn = document.getElementById("loadQuestsBtn");
  const questState = document.getElementById("questState");
  const questTable = document.getElementById("questTable");
  const questTbody = document.getElementById("questTbody");

  const jobStatus = document.getElementById("jobStatus");
  const loadJobsBtn = document.getElementById("loadJobsBtn");
  const jobState = document.getElementById("jobState");
  const jobTable = document.getElementById("jobTable");
  const jobTbody = document.getElementById("jobTbody");

  // =========================
  // Helpers
  // =========================
  function esc(s){
    return String(s ?? "").replace(/[&<>"]/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
  }

  function setNotice(type, msg){
    notice.className = "notice show " + (type === "ok" ? "ok" : "err");
    notice.textContent = msg || "";
  }
  function clearNotice(){
    notice.className = "notice";
    notice.textContent = "";
  }

  async function safeRead(res){
    const ct = (res.headers.get("content-type") || "").toLowerCase();
    if (ct.includes("application/json")) {
      return await res.json().catch(() => ({}));
    }
    const t = await res.text().catch(() => "");
    return { _text: t };
  }

  // AUTH BYPASS: no cookies required
  async function jget(url){
    const r = await fetch(url, {
      method: "GET",
      headers: { "Accept":"application/json" },
      cache: "no-store",
    });
    const data = await safeRead(r);
    if (!r.ok || data.ok === false) {
      const cid = data.correlation_id ? `\ncorrelation_id: ${data.correlation_id}` : "";
      throw new Error((data.error || data.message || `HTTP ${r.status}`) + cid);
    }
    return data;
  }

  async function jpost(url, body){
    const r = await fetch(url, {
      method:"POST",
      headers:{ "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify(body || {}),
    });
    const data = await safeRead(r);
    if (!r.ok || data.ok === false) {
      const cid = data.correlation_id ? `\ncorrelation_id: ${data.correlation_id}` : "";
      throw new Error((data.error || data.message || `HTTP ${r.status}`) + cid);
    }
    return data;
  }

  // Local prompt fallback (keeps you moving even if prompt endpoint is down)
  function localQuestTilePrompt({ quest_code, title }){
    const safeTitle = title || quest_code || "HODOS Quest";
    const code = quest_code || "quest_code_here";

    const prompt =
`HODOS app quest tile art (single image).
Title: "${safeTitle}"
Quest code: "${code}"

Style: cinematic fantasy illustration, warm gold + clay palette, ancient mythic atmosphere, soft volumetric light, high detail, painterly realism, subtle UI-safe composition (leave space at top-left for difficulty pill and bottom-right for lock icon).
Subject: a symbolic scene that visually represents "${safeTitle}" without text.

Output: 1024x1024 PNG, no text, no watermark, no logo.`;

    const negative =
`text, watermark, logo, frame text, blurry, low-res, jpeg artifacts, deformed anatomy, extra limbs, gore, explicit nudity, hateful symbols`;

    return { prompt, negative_prompt: negative };
  }

  function questRow(q){
    const published = (q.is_published == 1 || q.is_published === true) ? "1" : "0";
    const rel = q.target_release_date || "";
    const hero = q.hero_image || "";
    return `
      <tr data-id="${esc(q.id)}" data-code="${esc(q.code)}">
        <td><code>${esc(q.code)}</code></td>
        <td><input data-k="title" value="${esc(q.title||"")}" /></td>
        <td>
          <select data-k="is_published">
            <option value="0" ${published==="0"?"selected":""}>0</option>
            <option value="1" ${published==="1"?"selected":""}>1</option>
          </select>
        </td>
        <td><input data-k="target_release_date" placeholder="YYYY-MM-DD" value="${esc(rel)}" /></td>
        <td><input data-k="hero_image" placeholder="assets/quests/${esc(q.code||"quest_code")}.jpg" value="${esc(hero)}" /></td>
        <td>
          <div class="row">
            <button class="btn" data-action="save">Save</button>
            <button class="btn" data-action="prompt">Gen Prompt</button>
            <button class="btn primary" data-action="queue">Queue Tile Job</button>
          </div>
        </td>
      </tr>
    `;
  }

  async function loadQuests(){
    clearNotice();
    questState.textContent = "Loading quests‚Ä¶";
    questTable.style.display = "none";
    questTbody.innerHTML = "";

    const slug = encodeURIComponent(appSlug.value);

    let data = null;
    let used = "";

    if (TRY_ADMIN_LIST_FIRST) {
      try {
        data = await jget(`${EP.questsListAdmin}?app_slug=${slug}`);
        used = "admin";
      } catch (e) {
        // fall back to public
        data = await jget(`${EP.questsListPublic}?app_slug=${slug}`);
        used = "public";
        setNotice("ok", `Loaded quests via PUBLIC endpoint (admin list failed).\n${e.message}`);
      }
    } else {
      data = await jget(`${EP.questsListPublic}?app_slug=${slug}`);
      used = "public";
    }

    const quests = Array.isArray(data.quests) ? data.quests : [];

    if (!quests.length){
      questState.textContent = "No quests returned.";
      return;
    }

    questState.innerHTML = `Loaded <strong>${quests.length}</strong> quests (${used}).`;
    questTable.style.display = "";
    questTbody.innerHTML = quests.map(questRow).join("");
  }

  async function loadJobs(){
    clearNotice();
    jobState.textContent = "Loading jobs‚Ä¶";
    jobTable.style.display = "none";
    jobTbody.innerHTML = "";

    const url =
      `${EP.jobsList}?app_slug=${encodeURIComponent(appSlug.value)}&status=${encodeURIComponent(jobStatus.value)}`;

    const data = await jget(url);
    const jobs = Array.isArray(data.jobs) ? data.jobs : [];

    if (!jobs.length){
      jobState.textContent = "No jobs found for this filter.";
      return;
    }
    jobState.innerHTML = `Loaded <strong>${jobs.length}</strong> jobs.`;
    jobTable.style.display = "";
    jobTbody.innerHTML = jobs.map(j => `
      <tr>
        <td><code>${esc(j.id)}</code></td>
        <td><code>${esc(j.quest_code)}</code></td>
        <td>${esc(j.job_type)}</td>
        <td>${esc(j.status)}</td>
        <td class="muted">${esc((j.prompt||"").slice(0,120))}${(j.prompt||"").length>120?"‚Ä¶":""}</td>
      </tr>
    `).join("");
  }

  // Delegated actions for quest table
  questTbody.addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-action]");
    if (!btn) return;

    const tr = btn.closest("tr");
    const id = Number(tr?.dataset?.id || 0);
    const code = tr?.dataset?.code || "";
    const action = btn.dataset.action;

    if (!id || !code) return;

    const fields = {};
    tr.querySelectorAll("[data-k]").forEach(el => fields[el.dataset.k] = el.value);

    try {
      btn.disabled = true;

      if (action === "save") {
        await jpost(EP.questsUpdate, { id, ...fields });
        btn.textContent = "Saved ‚úÖ";
        setTimeout(()=>btn.textContent="Save", 900);
      }

      if (action === "prompt") {
        // Try server prompt endpoint first; fallback local prompt
        let pr = null;
        try {
          pr = await jpost(EP.promptsQuestTile, { quest_code: code, title: fields.title || "" });
        } catch (err) {
          pr = localQuestTilePrompt({ quest_code: code, title: fields.title || "" });
          setNotice("ok", `Prompt endpoint failed, using LOCAL prompt generator.\n${err.message}`);
        }
        window.prompt("Quest Tile Prompt (copy):", pr.prompt || "");
      }

      if (action === "queue") {
        // Build prompt (server -> fallback local)
        let pr = null;
        try {
          pr = await jpost(EP.promptsQuestTile, { quest_code: code, title: fields.title || "" });
        } catch (err) {
          pr = localQuestTilePrompt({ quest_code: code, title: fields.title || "" });
          setNotice("ok", `Prompt endpoint failed, using LOCAL prompt generator.\n${err.message}`);
        }

        await jpost(EP.jobsCreate, {
          app_slug: appSlug.value,
          quest_code: code,
          job_type: "quest_tile",
          priority: 50,
          prompt: pr.prompt,
          negative_prompt: pr.negative_prompt
        });

        btn.textContent = "Queued ‚úÖ";
        setTimeout(()=>btn.textContent="Queue Tile Job", 900);
        await loadJobs();
      }
    } catch (err) {
      console.error(err);
      setNotice("err", err?.message || "Action failed");
      alert(err?.message || "Action failed");
    } finally {
      btn.disabled = false;
    }
  });

  // Buttons
  loadQuestsBtn.addEventListener("click", () => loadQuests().catch(err => setNotice("err", err.message)));
  loadJobsBtn.addEventListener("click", () => loadJobs().catch(err => setNotice("err", err.message)));

  reloadBtn.addEventListener("click", async () => {
    clearNotice();
    await loadQuests().catch(err => setNotice("err", err.message));
    await loadJobs().catch(err => setNotice("err", err.message));
  });

  hardResetBtn.addEventListener("click", () => {
    clearNotice();
    questState.textContent = "No data loaded yet.";
    jobState.textContent = "No jobs loaded yet.";
    questTable.style.display = "none";
    jobTable.style.display = "none";
    questTbody.innerHTML = "";
    jobTbody.innerHTML = "";
  });

  // Boot
  (async () => {
    await loadQuests().catch(err => setNotice("err", err.message));
    await loadJobs().catch(err => setNotice("err", err.message));
  })();
</script>
</body>
</html>
